@page "/"
@inject MLVScan.Services.WebScanService Scanner
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>MLVScan - Static Analysis</PageTitle>

<div class="home-container">
    <section class="hero-section">
        <div class="hero-background">
            <div class="gradient-orb orb-1"></div>
            <div class="gradient-orb orb-2"></div>
            <div class="gradient-orb orb-3"></div>
        </div>
        <div class="hero-content">
            <div class="hero-badge">
                <span>Security Analysis Tool</span>
            </div>
            <h1 class="hero-title">
                <span class="title-main">MLVScan</span>
                <span class="title-accent">Static Analysis</span>
            </h1>
            <p class="hero-subtitle">
                Protect your system with advanced static analysis. 
                Detect suspicious patterns, malware, and security threats without running it on your system.
            </p>
            
            <div class="upload-area">
                <label class="dropzone @(isScanning ? "scanning" : "") @(isDragOver ? "drag-over" : "")" 
                       @ref="dropzoneRef">
                    <InputFile @ref="fileInput" OnChange="HandleFileSelected" accept=".dll,.exe,.netmodule,.il" />
                    <div class="dropzone-content">
                        @if (isScanning)
                        {
                            <div class="scanning-state">
                                <div class="spinner"></div>
                                <p class="scanning-text">Scanning <strong>@(lastFileName ?? "file")</strong>...</p>
                                <p class="scanning-hint">This may take a few moments</p>
                            </div>
                        }
                        else
                        {
                            <div class="upload-state">
                                <div class="icon-upload">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                        <polyline points="17 8 12 3 7 8" />
                                        <line x1="12" y1="3" x2="12" y2="15" />
                                    </svg>
                                </div>
                                <div class="text-upload">
                                    <strong>Click to upload</strong> or drag and drop
                                </div>
                                <div class="file-types">
                                    <span class="file-type-badge">.dll</span>
                                    <span class="file-type-badge">.exe</span>
                                    <span class="file-type-badge">.netmodule</span>
                                    <span class="file-type-badge">.il</span>
                                </div>
                            </div>
                        }
                    </div>
                </label>
                @if (!string.IsNullOrWhiteSpace(error))
                {
                    <div class="error-message">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <span>@error</span>
                    </div>
                }
            </div>
        </div>
    </section>

    @if (result is not null)
    {
        <section class="dashboard-section" id="results">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon icon-blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="label">Total Findings</span>
                        <span class="value">@result.Findings.Count</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon icon-red">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                            <line x1="12" y1="9" x2="12" y2="13" />
                            <line x1="12" y1="17" x2="12.01" y2="17" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="label">Critical</span>
                        <span class="value">@GetSeverityCount(Severity.Critical)</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon icon-orange">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="8" x2="12" y2="12" />
                            <line x1="12" y1="16" x2="12.01" y2="16" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="label">High</span>
                        <span class="value">@GetSeverityCount(Severity.High)</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon icon-purple">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <span class="label">File Type</span>
                        <span class="value">DLL</span>
                    </div>
                </div>
            </div>

            <div class="results-panel">
                <div class="panel-header">
                    <div class="panel-header-left">
                        <h2 class="panel-title">Scan Results</h2>
                        <span class="panel-subtitle">@GetFilteredFindings().Count of @result.Findings.Count findings</span>
                    </div>
                    <div class="panel-header-right">
                        <div class="search-box">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8" />
                                <path d="m21 21-4.35-4.35" />
                            </svg>
                            <input type="text" placeholder="Search findings..." @bind="searchQuery" @bind:event="oninput" class="search-input" />
                            @if (!string.IsNullOrWhiteSpace(searchQuery))
                            {
                                <button class="search-clear" @onclick='() => searchQuery = ""'>
                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18" />
                                        <line x1="6" y1="6" x2="18" y2="18" />
                                    </svg>
                                </button>
                            }
                        </div>
                        <div class="filter-badges">
                            <button class="filter-badge @(selectedSeverity == null ? "active" : "")" @onclick='() => selectedSeverity = null'>
                                All
                            </button>
                            <button class="filter-badge @(selectedSeverity == Severity.Critical ? "active" : "")" @onclick='() => selectedSeverity = Severity.Critical'>
                                Critical (@GetSeverityCount(Severity.Critical))
                            </button>
                            <button class="filter-badge @(selectedSeverity == Severity.High ? "active" : "")" @onclick='() => selectedSeverity = Severity.High'>
                                High (@GetSeverityCount(Severity.High))
                            </button>
                            <button class="filter-badge @(selectedSeverity == Severity.Medium ? "active" : "")" @onclick='() => selectedSeverity = Severity.Medium'>
                                Medium (@GetSeverityCount(Severity.Medium))
                            </button>
                            <button class="filter-badge @(selectedSeverity == Severity.Low ? "active" : "")" @onclick='() => selectedSeverity = Severity.Low'>
                                Low (@GetSeverityCount(Severity.Low))
                            </button>
                        </div>
                        <div class="view-controls">
                            <button class="btn-toggle @(viewMode == "table" ? "active" : "")" @onclick='() => viewMode = "table"'>
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="8" y1="6" x2="21" y2="6" />
                                    <line x1="8" y1="12" x2="21" y2="12" />
                                    <line x1="8" y1="18" x2="21" y2="18" />
                                    <line x1="3" y1="6" x2="3.01" y2="6" />
                                    <line x1="3" y1="12" x2="3.01" y2="12" />
                                    <line x1="3" y1="18" x2="3.01" y2="18" />
                                </svg>
                                Table
                            </button>
                            <button class="btn-toggle @(viewMode == "cards" ? "active" : "")" @onclick='() => viewMode = "cards"'>
                                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7" />
                                    <rect x="14" y="3" width="7" height="7" />
                                    <rect x="14" y="14" width="7" height="7" />
                                    <rect x="3" y="14" width="7" height="7" />
                                </svg>
                                Cards
                            </button>
                        </div>
                    </div>
                </div>

                @if (viewMode == "table")
                {
                    <div class="table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th class="severity-col">SEVERITY</th>
                                    <th class="rule-col">RULE</th>
                                    <th class="description-col">DESCRIPTION</th>
                                    <th class="location-col">RISK</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (result.Findings.Count == 0)
                                {
                                    <tr>
                                        <td colspan="4" class="empty-cell">
                                            <div class="empty-state">
                                                <span class="pill pill--success">Clean</span>
                                                <p>No suspicious patterns detected in @(result?.FileName ?? "file")</p>
                                            </div>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var finding in GetFilteredFindings())
                                    {
                                        var isExpanded = expandedFindings.Contains(finding);
                                        var ruleInfo = GetRuleInfo(finding);
                                        var extractedUrls = ExtractUrls(finding);
                                        <tr class="finding-row @(isExpanded ? "expanded" : "")">
                                            <td class="severity-col">
                                                <span class="badge @GetSeverityClass(finding.Severity)">@finding.Severity</span>
                                            </td>
                                            <td class="rule-col">
                                                <div class="rule-info">
                                                    <div class="rule-name">@ruleInfo.Name</div>
                                                </div>
                                            </td>
                                            <td class="description-col">
                                                <div class="finding-desc">
                                                    <div class="finding-desc-main">@finding.Description</div>
                                                    @if (extractedUrls.Any())
                                                    {
                                                        <div class="extracted-urls">
                                                            <div class="urls-label">Found URLs:</div>
                                                            <div class="urls-list">
                                                                @foreach (var url in extractedUrls)
                                                                {
                                                                    <a href="@url" target="_blank" rel="noopener noreferrer" class="url-link">
                                                                        <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                                                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                                                            <polyline points="15 3 21 3 21 9" />
                                                                            <line x1="10" y1="14" x2="21" y2="3" />
                                                                        </svg>
                                                                        <span>@url</span>
                                                                    </a>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                    @if (!string.IsNullOrWhiteSpace(finding.CodeSnippet))
                                                    {
                                                        <button class="code-toggle" @onclick='() => ToggleFinding(finding)'>
                                                            @if (isExpanded)
                                                            {
                                                                <span>Hide code</span>
                                                            }
                                                            else
                                                            {
                                                                <span>Show code</span>
                                                            }
                                                            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" class="@(isExpanded ? "expanded" : "")">
                                                                <polyline points="6 9 12 15 18 9" />
                                                            </svg>
                                                        </button>
                                                        @if (isExpanded)
                                                        {
                                                            <div class="code-snippet-expanded">
                                                                <div class="code-snippet-header">
                                                                    <span>Code Snippet</span>
                                                                    <button class="code-copy" @onclick='() => CopyToClipboard(finding.CodeSnippet)'>
                                                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                                                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                                                                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                                                                        </svg>
                                                                        Copy
                                                                    </button>
                                                                </div>
                                                                <pre><code>@finding.CodeSnippet</code></pre>
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            </td>
                                            <td class="text-muted location-cell">
                                                @if (!string.IsNullOrWhiteSpace(ruleInfo.Explanation))
                                                {
                                                    <div class="rule-explanation-inline">@ruleInfo.Explanation</div>
                                                }
                                                else
                                                {
                                                    <span class="location-text" title="@finding.Location">@GetMethodDisplay(finding.Location)</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="cards-grid">
                        @if (result.Findings.Count == 0)
                        {
                            <div class="empty-state">
                                <span class="pill pill--success">Clean</span>
                                <p>No suspicious patterns detected in @(result?.FileName ?? "file")</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var finding in GetFilteredFindings())
                            {
                                var ruleInfo = GetRuleInfo(finding);
                                var extractedUrls = ExtractUrls(finding);
                                <div class="finding-card">
                                    <div class="finding-card-header">
                                        <span class="badge @GetSeverityClass(finding.Severity)">@finding.Severity</span>
                                        <div class="rule-name-badge">@ruleInfo.Name</div>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(ruleInfo.Explanation))
                                    {
                                        <div class="rule-explanation-card">
                                            <div class="rule-explanation-label">What this means:</div>
                                            <div class="rule-explanation-text">@ruleInfo.Explanation</div>
                                        </div>
                                    }
                                    <p class="description">@finding.Description</p>
                                    @if (extractedUrls.Any())
                                    {
                                        <div class="extracted-urls-card">
                                            <div class="urls-label">Found URLs:</div>
                                            <div class="urls-list">
                                                @foreach (var url in extractedUrls)
                                                {
                                                    <a href="@url" target="_blank" rel="noopener noreferrer" class="url-link">
                                                        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                                                            <polyline points="15 3 21 3 21 9" />
                                                            <line x1="10" y1="14" x2="21" y2="3" />
                                                        </svg>
                                                        <span>@url</span>
                                                    </a>
                                                }
                                            </div>
                                        </div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(finding.CodeSnippet))
                                    {
                                        <div class="code-block">
                                            <div class="code-block-header">
                                                <span>Code Snippet</span>
                                                <button class="code-copy" @onclick='() => CopyToClipboard(finding.CodeSnippet)'>
                                                    <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
                                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                                                    </svg>
                                                    Copy
                                                </button>
                                            </div>
                                            <pre><code>@finding.CodeSnippet</code></pre>
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        </section>
    }
</div>

@code {
    private ScanResult? result;
    private bool isScanning;
    private bool isDragOver = false;
    private string? error;
    private string? lastFileName;
    private string viewMode = "table";
    private string searchQuery = "";
    private Severity? selectedSeverity = null;
    private HashSet<ScanFinding> expandedFindings = new();
    private InputFile? fileInput;
    private ElementReference dropzoneRef;
    private IJSObjectReference? jsModule;

    private int GetSeverityCount(Severity severity) =>
        result?.Findings.Count(f => f.Severity == severity) ?? 0;

    private string GetSeverityClass(Severity severity) =>
        severity switch
        {
            Severity.Critical => "badge--critical",
            Severity.High => "badge--high",
            Severity.Medium => "badge--medium",
            Severity.Low => "badge--low",
            _ => string.Empty
        };

    private List<ScanFinding> GetFilteredFindings()
    {
        if (result == null) return new List<ScanFinding>();

        var findings = result.Findings.AsEnumerable();

        if (selectedSeverity.HasValue)
        {
            findings = findings.Where(f => f.Severity == selectedSeverity.Value);
        }

        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            var query = searchQuery.ToLowerInvariant();
            findings = findings.Where(f =>
                f.Description.ToLowerInvariant().Contains(query) ||
                f.Location.ToLowerInvariant().Contains(query) ||
                (f.CodeSnippet?.ToLowerInvariant().Contains(query) ?? false)
            );
        }

        return findings.OrderByDescending(f => f.Severity).ThenBy(f => f.Location).ToList();
    }

    private void ToggleFinding(ScanFinding finding)
    {
        if (expandedFindings.Contains(finding))
        {
            expandedFindings.Remove(finding);
        }
        else
        {
            expandedFindings.Add(finding);
        }
        StateHasChanged();
    }

    private async Task CopyToClipboard(string text)
    {
        // Note: This requires JavaScript interop in a real implementation
        // For now, we'll just show a visual feedback
        await Task.CompletedTask;
    }

    private string GetMethodDisplay(string location)
    {
        if (string.IsNullOrWhiteSpace(location))
            return "Unknown";

        // Extract method name from location format: "Namespace.Type.Method:offset" or "Namespace.Type.Method"
        var parts = location.Split(':');
        var methodPath = parts[0];
        
        // Get the last part after the last dot (method name)
        var lastDotIndex = methodPath.LastIndexOf('.');
        if (lastDotIndex >= 0 && lastDotIndex < methodPath.Length - 1)
        {
            return methodPath.Substring(lastDotIndex + 1);
        }
        
        // If no dot found, return the whole thing
        return methodPath;
    }

    private (string Name, string Explanation) GetRuleInfo(ScanFinding finding)
    {
        var description = finding.Description.ToLowerInvariant();
        var codeSnippet = finding.CodeSnippet?.ToLowerInvariant() ?? "";

        // Extract rule name from description patterns - check most specific first
        string ruleName = "Unknown Rule";
        string explanation = "";

        // Shell32Rule - "Potential system shell execution detected"
        if (description.Contains("potential system shell execution") || description.Contains("shell execution"))
        {
            ruleName = "Shell Execution";
            explanation = "This mod is using Windows Shell32 functions to execute system commands. This can be used to run arbitrary programs, execute scripts, or perform system-level operations.";
        }
        // COMReflectionAttackRule - "Detected reflective shell execution via COM"
        else if (description.Contains("reflective shell execution via com") || description.Contains("gettypefromprogid") && description.Contains("invokemember"))
        {
            ruleName = "COM Reflection Attack";
            explanation = "This mod is using COM (Component Object Model) reflection techniques to execute code. This advanced attack vector bypasses .NET security mechanisms by using COM interop to call system functions dynamically.";
        }
        // ProcessStartRule - "Detected Process.Start call"
        else if (description.Contains("process.start") || description.Contains("process start") || description.Contains("could execute arbitrary programs"))
        {
            ruleName = "Process Execution";
            explanation = "This mod can execute external programs or processes. This is highly dangerous as it could run malicious software, install malware, or perform unauthorized system operations.";
        }
        // RegistryRule - "Detected registry manipulation"
        else if (description.Contains("registry manipulation") || description.Contains("registry") && description.Contains("suspicious"))
        {
            ruleName = "Registry Manipulation";
            explanation = "This mod is accessing or modifying the Windows Registry. This could be used to modify system settings, install persistence mechanisms, or read sensitive configuration data.";
        }
        // LoadFromStreamRule - "Detected dynamic assembly loading"
        else if (description.Contains("dynamic assembly loading") || description.Contains("loadfromstream") || description.Contains("could be used to execute hidden code"))
        {
            ruleName = "Dynamic Assembly Loading";
            explanation = "This mod is loading assemblies from memory or streams. This technique is commonly used by malware to load encrypted or obfuscated code at runtime, avoiding static analysis.";
        }
        // DllImportRule - Various descriptions
        else if (description.Contains("dllimport") || description.Contains("dll import") || description.Contains("high-risk dllimport") || description.Contains("medium-risk dllimport"))
        {
            ruleName = "Native DLL Import";
            explanation = "This mod is importing functions from native Windows DLLs. While sometimes legitimate, this can be used to bypass .NET security and call low-level system functions directly.";
        }
        // EncodedStringPipelineRule - "Detected encoded string to char decoding pipeline"
        else if (description.Contains("encoded string to char decoding pipeline") || description.Contains("ascii number parsing pattern"))
        {
            ruleName = "Encoded String Pipeline";
            explanation = "This mod is using a complex encoding pipeline to decode obfuscated strings at runtime. This technique uses LINQ operations (Select, Concat) to convert numeric strings to characters, hiding malicious content from static analysis.";
        }
        // EncodedBlobSplittingRule - "Detected structured encoded blob splitting pattern"
        else if (description.Contains("structured encoded blob splitting") || description.Contains("backtick") || description.Contains("separator in loop"))
        {
            ruleName = "Encoded Blob Splitting";
            explanation = "This mod is splitting encoded data blobs using separators (backtick or dash) in loops. This is a sophisticated obfuscation technique used to hide malicious payloads by splitting them across multiple encoded segments.";
        }
        // EncodedStringLiteralRule - "Detected numeric-encoded string literals"
        else if (description.Contains("numeric-encoded string") || description.Contains("numeric encoded") || description.Contains("encoded string literal"))
        {
            ruleName = "Numeric String Encoding";
            explanation = "This mod is using numeric-encoded string literals (dash, dot, or backtick separated numbers). This technique converts ASCII codes to numbers to hide URLs, commands, or payloads from static analysis.";
        }
        // HexStringRule - "Detected hexadecimal encoded string"
        else if (description.Contains("hexadecimal encoded string") || description.Contains("hex-encoded string") || description.Contains("hex string"))
        {
            ruleName = "Hex String Encoding";
            explanation = "This mod is using hexadecimal-encoded strings. This is another obfuscation technique used to hide sensitive data like URLs, commands, or payloads from casual inspection.";
        }
        // ReflectionRule - "Detected reflection invocation without determinable target method"
        else if (description.Contains("reflection invocation") || description.Contains("reflection") && description.Contains("bypass"))
        {
            ruleName = "Reflection Invocation";
            explanation = "This mod is using .NET Reflection to dynamically invoke methods without a determinable target. This technique can bypass access controls, hide malicious code, or call private methods that shouldn't be accessible.";
        }
        // DataExfiltrationRule - Various patterns
        else if (description.Contains("discord webhook") || description.Contains("data exfiltration") || description.Contains("data-sending operation") || description.Contains("suspicious endpoint") || description.Contains("potential payload download"))
        {
            ruleName = "Data Exfiltration";
            explanation = "This mod is sending data to external endpoints like Discord webhooks, paste sites, or suspicious URLs. This could be stealing your data, credentials, or system information.";
        }
        // PersistenceRule - "Detected executable write near persistence-prone directory"
        else if (description.Contains("executable write") && description.Contains("persistence") || description.Contains("startup") && description.Contains("appdata") && description.Contains("programdata"))
        {
            ruleName = "Persistence Mechanism";
            explanation = "This mod is writing executable files to persistence-prone directories (Startup, AppData, ProgramData). This could install malware that runs automatically on system startup, maintaining access even after reboots.";
        }
        // EnvironmentPathRule - "Detected Environment.GetFolderPath access"
        else if (description.Contains("environment.getfolderpath") || description.Contains("sensitive directories") && description.Contains("appdata"))
        {
            ruleName = "Sensitive Directory Access";
            explanation = "This mod is accessing sensitive system directories like AppData, Startup, or ProgramData. While sometimes legitimate, this could be used to install persistence mechanisms or access sensitive user data.";
        }
        // ByteArrayManipulationRule - "Detected byte array manipulation"
        else if (description.Contains("byte array manipulation") || description.Contains("bytearray"))
        {
            ruleName = "Byte Array Manipulation";
            explanation = "This mod is manipulating byte arrays, which could be used to decrypt payloads, modify memory, or perform low-level data operations. While sometimes legitimate (e.g., audio processing), this is also common in obfuscated malware.";
        }
        // Base64Rule - "Detected FromBase64String call"
        else if (description.Contains("frombase64string") || description.Contains("base64") && description.Contains("decodes"))
        {
            ruleName = "Base64 Decoding";
            explanation = "This mod is decoding base64-encoded strings. This is commonly used to obfuscate sensitive data like URLs, API keys, or malicious payloads. While base64 encoding itself isn't malicious, it's often used to hide suspicious content.";
        }
        // Network operations (fallback)
        else if (description.Contains("network") || description.Contains("http") || description.Contains("webhook") || description.Contains("endpoint"))
        {
            ruleName = "Network Communication";
            explanation = "This mod is making network requests. While some mods legitimately check for updates or download resources, this could also be used to exfiltrate data, download malware, or communicate with command-and-control servers.";
        }

        return (ruleName, explanation);
    }

    private List<string> ExtractUrls(ScanFinding finding)
    {
        var urls = new List<string>();
        var text = $"{finding.Description} {finding.CodeSnippet ?? ""}";

        // Match URLs in the format: URL(s): http://example.com, https://example.com
        var urlMatch = System.Text.RegularExpressions.Regex.Match(text, @"URL\(s\):\s*([^\n]+)");
        if (urlMatch.Success)
        {
            var urlString = urlMatch.Groups[1].Value;
            var urlMatches = System.Text.RegularExpressions.Regex.Matches(urlString, @"(https?://[^\s,]+)");
            foreach (System.Text.RegularExpressions.Match match in urlMatches)
            {
                urls.Add(match.Value.Trim());
            }
        }

        // Also extract URLs directly from text
        var directUrlMatches = System.Text.RegularExpressions.Regex.Matches(text, @"(https?://[^\s""'<>]+)");
        foreach (System.Text.RegularExpressions.Match match in directUrlMatches)
        {
            var url = match.Value.Trim();
            if (!urls.Contains(url))
            {
                urls.Add(url);
            }
        }

        return urls.Distinct().ToList();
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs args)
    {
        error = null;
        result = null;

        var file = args.File;
        if (file is null)
        {
            error = "No file selected.";
            return;
        }

        lastFileName = file.Name;

        try
        {
            isScanning = true;
            StateHasChanged();
            result = await Scanner.ScanAsync(file);
        }
        catch (Exception ex)
        {
            error = $"Scan failed: {ex.Message}";
        }
        finally
        {
            isScanning = false;
        }
    }

    [JSInvokable]
    public void SetDragOver(bool dragOver)
    {
        isDragOver = dragOver;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnFileDropped(byte[] fileData, string fileName, string contentType)
    {
        if (isScanning)
            return;

        try
        {
            // Create a custom IBrowserFile implementation from the dropped file data
            var browserFile = new DroppedBrowserFile(fileData, fileName, contentType);
            
            // Call HandleFileSelected directly with the file
            error = null;
            result = null;
            lastFileName = browserFile.Name;

            isScanning = true;
            StateHasChanged();
            result = await Scanner.ScanAsync(browserFile);
        }
        catch (Exception ex)
        {
            error = $"Failed to process dropped file: {ex.Message}";
        }
        finally
        {
            isScanning = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsureJsModuleLoaded();
            if (jsModule != null)
            {
                await jsModule.InvokeVoidAsync("initializeDropzone", dropzoneRef, DotNetObjectReference.Create(this));
            }
        }
    }

    private async Task EnsureJsModuleLoaded()
    {
        if (jsModule == null)
        {
            jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/fileDrop.js");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (jsModule != null)
        {
            await jsModule.DisposeAsync();
        }
    }
}

